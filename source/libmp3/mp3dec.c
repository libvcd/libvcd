/**********seekfor mpegdec v20.15.12.10*********************************************
	seekfor mpegdec v20.15.12.10是免费的MPEG编解码软件,您可以自由使用和拷贝本程序!
	在使用和拷贝时请注意保留原来的版权信息.
	如果您有什么问题和意见,请和我联系!
	QQ:82054357
	QQ群:24613876
	MSN:sfrad32@hotmail.com
	Mail:Seek_for@163.com
***********************************************************************************/
#include <common.h>

#define MODE_ST			0x00
#define MODE_JST		0x01
#define MODE_2CH		0x02
#define MODE_1CH		0x03

#define SF_44100		0x00
#define SF_48000		0x01
#define SF_32000		0x02
#define SF_RESERVED		0x03

#define LAYER_RESERVED	0x00
#define LAYER_MP1		0x01
#define LAYER_MP2		0x02
#define LAYER_MP3		0x03


typedef struct
{
	double C;
	double D;
}CD_ITEM;

typedef struct
{
	unsigned short steps;
	unsigned char bits;
	unsigned char group;
	unsigned char quant;
}BIT_ALLOC;

static BIT_ALLOC alloc_0[][16] =
{
	{{0,4,0,0},{3,5,1,0},{7,3,3,2},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{16383,14,3,14},{32767,15,3,15},{65535,16,3,16}},
	{{0,4,0,0},{3,5,1,0},{7,3,3,2},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{16383,14,3,14},{32767,15,3,15},{65535,16,3,16}},
	{{0,4,0,0},{3,5,1,0},{7,3,3,2},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{16383,14,3,14},{32767,15,3,15},{65535,16,3,16}},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16}},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16}},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16}},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16}},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16}},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16}},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16}},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,2,0,0},{3,5,1,0},{5,7,1,1},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,2,0,0},{3,5,1,0},{5,7,1,1},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,2,0,0},{3,5,1,0},{5,7,1,1},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
	{{0,2,0,0},{3,5,1,0},{5,7,1,1},{65535,16,3,16},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}}
};

static BIT_ALLOC alloc_1[][16] =
{
	{{0,4,0,0},{3,5,1,0},{7,3,3,2},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{16383,14,3,14},{32767,15,3,15},{65535,16,3,16},},
	{{0,4,0,0},{3,5,1,0},{7,3,3,2},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{16383,14,3,14},{32767,15,3,15},{65535,16,3,16},},
	{{0,4,0,0},{3,5,1,0},{7,3,3,2},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{16383,14,3,14},{32767,15,3,15},{65535,16,3,16},},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16},},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16},},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16},},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16},},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16},},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16},},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16},},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{65535,16,3,16},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{7,3,3,2},{9,10,1,3},{15,4,3,4},{31,5,3,5},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,2,0,0},{3,5,1,0},{5,7,1,1},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,2,0,0},{3,5,1,0},{5,7,1,1},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,2,0,0},{3,5,1,0},{5,7,1,1},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,2,0,0},{3,5,1,0},{5,7,1,1},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,2,0,0},{3,5,1,0},{5,7,1,1},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,2,0,0},{3,5,1,0},{5,7,1,1},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,2,0,0},{3,5,1,0},{5,7,1,1},{65535,16,3,16},{65535,16,3,16},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},}
};

static BIT_ALLOC alloc_2[][16] =
{
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{16383,14,3,14},{32767,15,3,15},},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{16383,14,3,14},{32767,15,3,15},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},}
};

static BIT_ALLOC alloc_3[][16] =
{
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{16383,14,3,14},{32767,15,3,15},},
	{{0,4,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{255,8,3,8},{511,9,3,9},{1023,10,3,10},{2047,11,3,11},{4095,12,3,12},{8191,13,3,13},{16383,14,3,14},{32767,15,3,15},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},},
	{{0,3,0,0},{3,5,1,0},{5,7,1,1},{9,10,1,3},{15,4,3,4},{31,5,3,5},{63,6,3,6},{127,7,3,7},{127,7,3,7},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},}
};


static double D[512] =
{
	 0.000000000,-0.000015259,-0.000015259,-0.000015259,
	-0.000015259,-0.000015259,-0.000015259,-0.000030518,
	-0.000030518,-0.000030518,-0.000030518,-0.000045776,
	-0.000045776,-0.000061035,-0.000061035,-0.000076294,
	-0.000076294,-0.000091553,-0.000106812,-0.000106812,
	-0.000122070,-0.000137329,-0.000152588,-0.000167847,
	-0.000198364,-0.000213623,-0.000244141,-0.000259399,
	-0.000289917,-0.000320435,-0.000366211,-0.000396729,
	-0.000442505,-0.000473022,-0.000534058,-0.000579834,
	-0.000625610,-0.000686646,-0.000747681,-0.000808716,
	-0.000885010,-0.000961304,-0.001037598,-0.001113892,
	-0.001205444,-0.001296997,-0.001388550,-0.001480103,
	-0.001586914,-0.001693726,-0.001785278,-0.001907349,
	-0.002014160,-0.002120972,-0.002243042,-0.002349854,
	-0.002456665,-0.002578735,-0.002685547,-0.002792358,
	-0.002899170,-0.002990723,-0.003082275,-0.003173828,
	 0.003250122, 0.003326416, 0.003387451, 0.003433228,
	 0.003463745, 0.003479004, 0.003479004, 0.003463745,
	 0.003417969, 0.003372192, 0.003280640, 0.003173828,
	 0.003051758, 0.002883911, 0.002700806, 0.002487183,
	 0.002227783, 0.001937866, 0.001617432, 0.001266479,
	 0.000869751, 0.000442505,-0.000030518,-0.000549316,
	-0.001098633,-0.001693726,-0.002334595,-0.003005981,
	-0.003723145,-0.004486084,-0.005294800,-0.006118774,
	-0.007003784,-0.007919312,-0.008865356,-0.009841919,
	-0.010848999,-0.011886597,-0.012939453,-0.014022827,
	-0.015121460,-0.016235352,-0.017349243,-0.018463135,
	-0.019577026,-0.020690918,-0.021789551,-0.022857666,
	-0.023910522,-0.024932861,-0.025909424,-0.026840210,
	-0.027725220,-0.028533936,-0.029281616,-0.029937744,
	-0.030532837,-0.031005859,-0.031387329,-0.031661987,
	-0.031814575,-0.031845093,-0.031738281,-0.031478882,
	 0.031082153, 0.030517578, 0.029785156, 0.028884888,
	 0.027801514, 0.026535034, 0.025085449, 0.023422241,
	 0.021575928, 0.019531250, 0.017257690, 0.014801025,
	 0.012115479, 0.009231567, 0.006134033, 0.002822876,
	-0.000686646,-0.004394531,-0.008316040,-0.012420654,
	-0.016708374,-0.021179199,-0.025817871,-0.030609131,
	-0.035552979,-0.040634155,-0.045837402,-0.051132202,
	-0.056533813,-0.061996460,-0.067520142,-0.073059082,
	-0.078628540,-0.084182739,-0.089706421,-0.095169067,
	-0.100540161,-0.105819702,-0.110946655,-0.115921021,
	-0.120697021,-0.125259399,-0.129562378,-0.133590698,
	-0.137298584,-0.140670776,-0.143676758,-0.146255493,
	-0.148422241,-0.150115967,-0.151306152,-0.151962280,
	-0.152069092,-0.151596069,-0.150497437,-0.148773193,
	-0.146362305,-0.143264771,-0.139450073,-0.134887695,
	-0.129577637,-0.123474121,-0.116577148,-0.108856201,
	 0.100311279, 0.090927124, 0.080688477, 0.069595337,
	 0.057617187, 0.044784546, 0.031082153, 0.016510010,
	 0.001068115,-0.015228271,-0.032379150,-0.050354004,
	-0.069168091,-0.088775635,-0.109161377,-0.130310059,
	-0.152206421,-0.174789429,-0.198059082,-0.221984863,
	-0.246505737,-0.271591187,-0.297210693,-0.323318481,
	-0.349868774,-0.376800537,-0.404083252,-0.431655884,
	-0.459472656,-0.487472534,-0.515609741,-0.543823242,
	-0.572036743,-0.600219727,-0.628295898,-0.656219482,
	-0.683914185,-0.711318970,-0.738372803,-0.765029907,
	-0.791213989,-0.816864014,-0.841949463,-0.866363525,
	-0.890090942,-0.913055420,-0.935195923,-0.956481934,
	-0.976852417,-0.996246338,-1.014617920,-1.031936646,
	-1.048156738,-1.063217163,-1.077117920,-1.089782715,
	-1.101211548,-1.111373901,-1.120223999,-1.127746582,
	-1.133926392,-1.138763428,-1.142211914,-1.144287109,
	 1.144989014, 1.144287109, 1.142211914, 1.138763428,
	 1.133926392, 1.127746582, 1.120223999, 1.111373901,
	 1.101211548, 1.089782715, 1.077117920, 1.063217163,
	 1.048156738, 1.031936646, 1.014617920, 0.996246338,
	 0.976852417, 0.956481934, 0.935195923, 0.913055420,
	 0.890090942, 0.866363525, 0.841949463, 0.816864014,
	 0.791213989, 0.765029907, 0.738372803, 0.711318970,
	 0.683914185, 0.656219482, 0.628295898, 0.600219727,
	 0.572036743, 0.543823242, 0.515609741, 0.487472534,
	 0.459472656, 0.431655884, 0.404083252, 0.376800537,
	 0.349868774, 0.323318481, 0.297210693, 0.271591187,
	 0.246505737, 0.221984863, 0.198059082, 0.174789429,
	 0.152206421, 0.130310059, 0.109161377, 0.088775635,
	 0.069168091, 0.050354004, 0.032379150, 0.015228271,
	-0.001068115,-0.016510010,-0.031082153,-0.044784546,
	-0.057617187,-0.069595337,-0.080688477,-0.090927124,
	 0.100311279, 0.108856201, 0.116577148, 0.123474121,
	 0.129577637, 0.134887695, 0.139450073, 0.143264771,
	 0.146362305, 0.148773193, 0.150497437, 0.151596069,
	 0.152069092, 0.151962280, 0.151306152, 0.150115967,
	 0.148422241, 0.146255493, 0.143676758, 0.140670776,
	 0.137298584, 0.133590698, 0.129562378, 0.125259399,
	 0.120697021, 0.115921021, 0.110946655, 0.105819702,
	 0.100540161, 0.095169067, 0.089706421, 0.084182739,
	 0.078628540, 0.073059082, 0.067520142, 0.061996460,
	 0.056533813, 0.051132202, 0.045837402, 0.040634155,
	 0.035552979, 0.030609131, 0.025817871, 0.021179199,
	 0.016708374, 0.012420654, 0.008316040, 0.004394531,
	 0.000686646,-0.002822876,-0.006134033,-0.009231567,
	-0.012115479,-0.014801025,-0.017257690,-0.019531250,
	-0.021575928,-0.023422241,-0.025085449,-0.026535034,
	-0.027801514,-0.028884888,-0.029785156,-0.030517578,
	 0.031082153, 0.031478882, 0.031738281, 0.031845093,
	 0.031814575, 0.031661987, 0.031387329, 0.031005859,
	 0.030532837, 0.029937744, 0.029281616, 0.028533936,
	 0.027725220, 0.026840210, 0.025909424, 0.024932861,
	 0.023910522, 0.022857666, 0.021789551, 0.020690918,
	 0.019577026, 0.018463135, 0.017349243, 0.016235352,
	 0.015121460, 0.014022827, 0.012939453, 0.011886597,
	 0.010848999, 0.009841919, 0.008865356, 0.007919312,
	 0.007003784, 0.006118774, 0.005294800, 0.004486084,
	 0.003723145, 0.003005981, 0.002334595, 0.001693726,
	 0.001098633, 0.000549316, 0.000030518,-0.000442505,
	-0.000869751,-0.001266479,-0.001617432,-0.001937866,
	-0.002227783,-0.002487183,-0.002700806,-0.002883911,
	-0.003051758,-0.003173828,-0.003280640,-0.003372192,
	-0.003417969,-0.003463745,-0.003479004,-0.003479004,
	-0.003463745,-0.003433228,-0.003387451,-0.003326416,
	 0.003250122, 0.003173828, 0.003082275, 0.002990723,
	 0.002899170, 0.002792358, 0.002685547, 0.002578735,
	 0.002456665, 0.002349854, 0.002243042, 0.002120972,
	 0.002014160, 0.001907349, 0.001785278, 0.001693726,
	 0.001586914, 0.001480103, 0.001388550, 0.001296997,
	 0.001205444, 0.001113892, 0.001037598, 0.000961304,
	 0.000885010, 0.000808716, 0.000747681, 0.000686646,
	 0.000625610, 0.000579834, 0.000534058, 0.000473022,
	 0.000442505, 0.000396729, 0.000366211, 0.000320435,
	 0.000289917, 0.000259399, 0.000244141, 0.000213623,
	 0.000198364, 0.000167847, 0.000152588, 0.000137329,
	 0.000122070, 0.000106812, 0.000106812, 0.000091553,
	 0.000076294, 0.000076294, 0.000061035, 0.000061035,
	 0.000045776, 0.000045776, 0.000030518, 0.000030518,
	 0.000030518, 0.000030518, 0.000015259, 0.000015259,
	 0.000015259, 0.000015259, 0.000015259, 0.000015259,
};

static double SF[] =
{
	2.00000000000000,1.58740105196820,1.25992104989487,1.00000000000000,
	0.79370052598410,0.62996052494744,0.50000000000000,0.39685026299205,
	0.31498026247372,0.25000000000000,0.19842513149602,0.15749013123686,
	0.12500000000000,0.09921256574801,0.07874506561843,0.06250000000000,
	0.04960628287401,0.03937253280921,0.03125000000000,0.02480314143700,
	0.01968626640461,0.01562500000000,0.01240157071850,0.00984313320230,
	0.00781250000000,0.00620078535925,0.00492156660115,0.00390625000000,
	0.00310039267963,0.00246078330058,0.00195312500000,0.00155019633981,
	0.00123039165029,0.00097656250000,0.00077509816991,0.00061519582514,
	0.00048828125000,0.00038754908495,0.00030759791257,0.00024414062500,
	0.00019377454248,0.00015379895629,0.00012207031250,0.00009688727124,
	0.00007689947814,0.00006103515625,0.00004844363562,0.00003844973907,
	0.00003051757813,0.00002422181781,0.00001922486954,0.00001525878906,
	0.00001211090890,0.00000961243477,0.00000762939453,0.00000605545445,
	0.00000480621738,0.00000381469727,0.00000302772723,0.00000240310869,
	0.00000190734863,0.00000151386361,0.00000120155435,0.00000000000000
};

static unsigned char BAT[4][15] =
{
	{1,2,2,0,0,0,1,1,1,1,1,0,0,0,0},/*44.1K*/
	{0,2,2,0,0,0,0,0,0,0,0,0,0,0,0},/*48K*/
	{0,3,3,0,0,0,1,1,1,1,1,0,0,0,0},/*32K*/
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}/*none*/
};

static unsigned char SBLIMIT[][15] =
{
	{32, 8, 8,27,27,27,30,30,30,30,30,32,32,32,32},/*44100*/
	{32, 8, 8,27,27,27,27,27,27,27,27,32,32,32,32},/*48000*/
	{32,12,12,27,27,27,30,30,30,30,30,32,32,32,32},/*32000*/
	{32,32,32,32,32,32,32,32,32,32,32,32,32,32,32}/*reserved*/
};


static CD_ITEM cd[] =
{
	{1.33333333333,0.50000000000},
	{1.60000000000,0.50000000000},
	{1.14285714286,0.25000000000},
	{1.77777777777,0.50000000000},
	{1.06666666666,0.12500000000},
	{1.03225806452,0.06250000000},
	{1.01587301587,0.03125000000},
	{1.00787401575,0.01562500000},
	{1.00392156863,0.00781250000},
	{1.00195694716,0.00390625000},
	{1.00097751711,0.00195312500},
	{1.00048851979,0.00097656250},
	{1.00024420024,0.00048828125},
	{1.00012208522,0.00024414063},
	{1.00006103888,0.00012207031},
	{1.00003051851,0.00006103516},
	{1.00001525902,0.00003051758}
};


typedef struct
{
	bitstream_t bs;

	double Nik[64][32];

	unsigned short syncword;
	unsigned char	id;
	unsigned char	layer;
	unsigned char	protection_bit;
	unsigned char	bitrate_index;
	unsigned char	sampling_frequency;
	unsigned char	padding_bit;
	unsigned char	private_bit;
	unsigned char	mode;
	unsigned char	mode_extension;
	unsigned char	copyright;
	unsigned char	original_copy;
	unsigned char	emphasis;


	char buf[8192];
	int buf_size;

	short int* pcm;
	int pcm_size;
}mp3dec_t;

static double format(unsigned short sample,unsigned char x,unsigned char quant,unsigned char scale)
{
	double fraction;
	if (((sample >> x) & 1) == 1)
	{
		fraction = 0.0;
	}
	else  
	{
		fraction = -1.0;
	}
	fraction += (double)(sample & ((1 << x) - 1)) / (double)(1L << x);
	fraction += cd[quant].D;
	fraction *= cd[quant].C;							
	fraction *= SF[scale];
	return fraction;
}

static void imdct(mp3dec_t* dec,double S[32],unsigned short sample[32],unsigned char channel)
{
	double sum;
	unsigned short int i,j,k;
	double V[1024];
	double U[512];
	double W[512];

	for(i = 0;i < 64;i++)
	{
		V[i] = 0;
		for(j = 0;j < 32;j++)
		{
			V[i] += dec->Nik[i][j] * S[j];
		}
		for(k = 1;k < 16;k++)
		{
			V[i + (k << 6)] = V[i];
		}
	}

	for(i = 0;i < 8;i++)
	{
		for(j = 0;j < 32;j++)
		{
			U[(i << 6) + j] = V[(i << 7) + j];
			U[(i << 6) + 32 + j] = V[(i << 7) + 96 + j];
		}
	}

	for(i = 0;i < 512;i++)
	{
		W[i] = U[i] * D[i];
	}

	for(j = 0;j < 32;j++)
	{
		sum = 0.0;
		for(i = 0;i < 16;i++)
		{
			sum += W[j + (i << 5)];
		}
		sample[j] = (unsigned short)(sum * 32768.0f);
	}
}


static void header(mp3dec_t* dec)
{
	unsigned char BITRATE[]=
	{
		0,1,2,3,1,5,2,3,4,5,6,7,8,9,10,0
	};
	bitstream_t* bs = &dec->bs;
	dec->syncword = bs_get(bs,12,1);
	dec->id = bs_get(bs,1,1);
	dec->layer = 4 - bs_get(bs,2,1);
	dec->protection_bit = bs_get(bs,1,1);
	dec->bitrate_index = bs_get(bs,4,1);
	dec->sampling_frequency = bs_get(bs,2,1);
	dec->padding_bit = bs_get(bs,1,1);
	dec->private_bit = bs_get(bs,1,1);
	dec->mode = bs_get(bs,2,1);
	dec->mode_extension = bs_get(bs,2,1);
	dec->copyright = bs_get(bs,1,1);
	dec->original_copy = bs_get(bs,1,1);
	dec->emphasis = bs_get(bs,2,1);
	if(dec->mode != MODE_1CH)
	{
		dec->bitrate_index = BITRATE[dec->bitrate_index];
	}
}

static void error_check(mp3dec_t* dec)
{
	if(dec->protection_bit == 0)
	{
		bs_skip(&dec->bs,16);
	}
}

static void MP3_data(mp3dec_t* dec)
{

}

static void MP2_data(mp3dec_t* dec)
{
	bitstream_t* bs = &dec->bs;
	double fraction[2][3][32];
	unsigned short pcm[2][32];
	unsigned char allocation[2][32];
	unsigned char scfsi[2][32];
	unsigned char scalefactor[2][3][32];
	unsigned short sample[2][3][32];
	unsigned short int buf[64];
	unsigned char sb,bound,sblimit;
	unsigned char ch,chs;
	unsigned char gr,x;
	unsigned char bits,quant,group;
	unsigned short temp,level;
	BIT_ALLOC *table;
	BIT_ALLOC* bit_alloc[] = {&alloc_0[0][0],&alloc_1[0][0],&alloc_2[0][0],&alloc_3[0][0]};
	int i;
	memset(fraction,0,sizeof(fraction));
	table = bit_alloc[BAT[dec->sampling_frequency][dec->bitrate_index]];
	sblimit = SBLIMIT[dec->sampling_frequency][dec->bitrate_index];
	bound = (dec->mode == MODE_JST)?((dec->mode_extension + 1) << 2):sblimit;
	chs = (dec->mode == MODE_1CH)?1:2;
	for(sb = 0;sb < bound;sb++)
	{
		i = (table + (sb << 4))[0].bits;
		for(ch = 0;ch < chs;ch++)
		{
			allocation[ch][sb] = bs_get(bs,i,1);
		}
	}
	for(sb = bound;sb < sblimit;sb++)
	{
		i = (table + (sb << 4))[0].bits;
		allocation[0][sb] = allocation[1][sb] = bs_get(bs,i,1);
	}

	for(sb = 0;sb < sblimit;sb++)
	{
		for(ch = 0;ch < chs;ch++)
		{
			scfsi[ch][sb] = allocation[ch][sb]?bs_get(bs,2,1):0;
		}
	}

	for(sb = 0;sb < sblimit;sb++)
	{
		for(ch = 0;ch < chs;ch++)
		{
			if(allocation[ch][sb])
			{
				switch(scfsi[ch][sb])
				{
				case 0:
					scalefactor[ch][0][sb] = bs_get(bs,6,1);
					scalefactor[ch][1][sb] = bs_get(bs,6,1);
					scalefactor[ch][2][sb] = bs_get(bs,6,1);
					break;
				case 1:
					scalefactor[ch][0][sb] = scalefactor[ch][1][sb] = bs_get(bs,6,1);
					scalefactor[ch][2][sb] = bs_get(bs,6,1);
					break;
				case 2:
					scalefactor[ch][0][sb] = scalefactor[ch][1][sb] = scalefactor[ch][2][sb] = bs_get(bs,6,1);
					break;
				case 3:
					scalefactor[ch][0][sb] = bs_get(bs,6,1);
					scalefactor[ch][1][sb] = scalefactor[ch][2][sb] = bs_get(bs,6,1);
					break;
				}
			}
			else
			{
				scalefactor[ch][0][sb] = scalefactor[ch][1][sb] = scalefactor[ch][2][sb] = 63;
			}
		}
	}

	for(gr = 0;gr < 12;gr++)
	{
		for(sb = 0;sb < bound;sb++)
		{
			for(ch = 0;ch < chs;ch++)
			{
				if(allocation[ch][sb])
				{
					bits = (table + (sb << 4))[allocation[ch][sb]].bits;
					level = (table + (sb << 4))[allocation[ch][sb]].steps;
					quant = (table + (sb << 4))[allocation[ch][sb]].quant;
					group = (table + (sb << 4))[allocation[ch][sb]].group;
					x = 0;
			        while((1L << x) < level)
					{
						x++;
					}
					x--;
					if(group == 3)
					{
						for(i = 0;i < 3;i++)
						{
							sample[ch][i][sb] = bs_get(bs,bits,1);
							fraction[ch][i][sb] = format(sample[ch][i][sb],x,quant,scalefactor[ch][gr >> 2][sb]);
						}
					}
					else
					{
						temp = bs_get(bs,bits,1);
						for(i = 0;i < 3;i++)
						{
							sample[ch][i][sb] = temp % level;
							fraction[ch][i][sb] = format(sample[ch][i][sb],x,quant,scalefactor[ch][gr >> 2][sb]);
							temp /= level;
						}
					}
				}
			}
		}

		for(sb = bound;sb < sblimit;sb++)
		{
			if(allocation[0][sb])
			{
				bits = (table + (sb << 4))[allocation[0][sb]].bits;
				level = (table + (sb << 4))[allocation[0][sb]].steps;
				quant = (table + (sb << 4))[allocation[0][sb]].quant;
				group = (table + (sb << 4))[allocation[0][sb]].group;
				x = 0;
			    while((1L << x) < level)
				{
					x++;
				}
				x--;
				if(group == 3)
				{
					for(i = 0;i < 3;i++)
					{
						sample[0][i][sb] = sample[1][i][sb] = bs_get(bs,bits,1);
						fraction[1][i][sb] = fraction[0][i][sb] = format(sample[0][i][sb],x,quant,scalefactor[0][gr >> 2][sb]);
					}
				}
				else
				{
					temp = bs_get(bs,bits,1);
					level = (table + (sb << 4))[allocation[0][sb]].steps;
					for(i = 0;i < 3;i++)
					{
						sample[0][i][sb] = sample[1][i][sb] = temp % level;
						fraction[1][i][sb] = fraction[0][i][sb] = format(sample[0][i][sb],x,quant,scalefactor[0][gr >> 2][sb]);
						temp /= level;
					}
				}
			}
		}

		/*输出3 * 32个样本*/
		for(i = 0;i < 3;i++)
		{
			if(chs == 1)
			{
				imdct(dec,&fraction[0][i][0],&pcm[0][0],0);
				for(sb = 0;sb < 32;sb++)
				{
					buf[sb << 1] = pcm[0][sb];
					buf[(sb << 1) + 1] = pcm[0][sb];
				}
			}
			else
			{
				imdct(dec,&fraction[0][i][0],&pcm[0][0],0);
				imdct(dec,&fraction[1][i][0],&pcm[1][0],1);
				for(sb = 0;sb < 32;sb++)
				{
					buf[sb << 1] = pcm[0][sb];
					buf[(sb << 1) + 1] = pcm[1][sb];
				}
			}
			if(dec->pcm)
			{
				memcpy(dec->pcm + dec->pcm_size,buf,64 * sizeof(short int));
				dec->pcm_size += 64;
			}
		}
	}
}

static void MP1_data(mp3dec_t* dec)
{
	bitstream_t* bs = &dec->bs;
	unsigned char sb,ch;
	unsigned char bound,s,chs,x;
	unsigned char allocation[2][32];
	unsigned char scalefactor[2][32];
	unsigned short sample[2][32];
	double fraction[2][32];
	unsigned short pcm[2][32];
	unsigned short int buf[64];
//	memset(fraction,0,sizeof(fraction));
	bound = (dec->mode == MODE_JST)?((dec->mode_extension + 1) << 2):32;
	chs = (dec->mode == MODE_1CH)?1:2;
	for(sb = 0;sb < bound;sb++)
	{
		for(ch = 0;ch < chs;ch++)
		{
			allocation[ch][sb] = bs_get(bs,4,1);
		}
	}
	for(sb = bound;sb < 32;sb++)
	{
		allocation[0][sb] = bs_get(bs,4,1);
		allocation[1][sb] = allocation[0][sb];
	}

	for(sb = 0;sb < 32;sb++)
	{
		for(ch = 0;ch < chs;ch++)
		{
			if(allocation[ch][sb])
			{
				scalefactor[ch][sb] = bs_get(bs,6,1);
			}
		}
	}


	for(s = 0;s < 12;s++)
	{

		for(sb = 0;sb < bound;sb++)
		{
			for(ch = 0;ch < chs;ch++)
			{
				if(allocation[ch][sb])
				{
					sample[ch][sb] = bs_get(bs,allocation[ch][sb] + 1,1);
					x = allocation[ch][sb];
					if (((sample[ch][sb] >> x) & 1) == 1) 
					{
						fraction[ch][sb] = 0.0;
					}
					else 
					{
						fraction[ch][sb] = -1.0;
					}
					fraction[ch][sb] += (double)(sample[ch][sb] & ((1 << x) - 1))/(double) (1L << x);
					x++;
					fraction[ch][sb] = (fraction[ch][sb] * (1l << x) + 1.0)/((1l << x) - 1);
					fraction[ch][sb] *= SF[scalefactor[ch][sb]];
				}
				else
				{
					fraction[ch][sb] = 0.0f;
				}
			}
		}

		for(sb = bound;sb < 32;sb++)
		{
			if(allocation[0][sb])
			{
				sample[0][sb] = bs_get(bs,allocation[ch][sb] + 1,1);
				x = allocation[0][sb];
				if (((sample[0][sb] >> x) & 1)==1) 
				{
					fraction[0][sb] = 0.0;
				}
				else 
				{
					fraction[0][sb] = -1.0;
				}
				fraction[0][sb] += (double)(sample[0][sb] & ((1 << x) - 1)) / (double)(1L << x);
				x++;
				fraction[0][sb]=(fraction[0][sb] * (1l << x) + 1.0) / ((1l << x) - 1);
				fraction[0][sb] *= SF[scalefactor[0][sb]];
				fraction[1][sb] = fraction[0][sb];
			}
			else
			{
				fraction[0][sb] = fraction[1][sb] = 0.0f;
			}
		}
		if(chs == 1)
		{
			imdct(dec,&fraction[0][0],&pcm[0][0],0);
			for(sb = 0;sb < 32;sb++)
			{
				buf[sb << 1] = pcm[0][sb];
				buf[(sb << 1) + 1] = pcm[0][sb];
			}
		}
		else
		{
			imdct(dec,&fraction[0][0],&pcm[0][0],0);
			imdct(dec,&fraction[1][0],&pcm[1][0],1);
			for(sb = 0;sb < 32;sb++)
			{
				buf[sb << 1] = pcm[0][sb];
				buf[(sb << 1) + 1] = pcm[1][sb];
			}
		}
		if(dec->pcm)
		{
			memcpy(dec->pcm + dec->pcm_size,buf,sizeof(buf));
			dec->pcm_size += 64;
		}
	}

}

static void audio_data(mp3dec_t* dec)
{
	typedef void (*AUDIO_DATA)(mp3dec_t*);
	AUDIO_DATA item[] =
	{
		MP1_data,MP1_data,MP2_data,MP3_data
	};
	item[dec->layer](dec);
}

static void ancillary_data(mp3dec_t* dec)
{

}



void* mp3dec_create()
{
	unsigned int i,j;
	mp3dec_t* dec = (mp3dec_t*)osMalloc(sizeof(mp3dec_t));
	if(dec)
	{
		memset(dec,0,sizeof(mp3dec_t));
		for(i = 0;i < 64;i++)
		{
			for(j = 0;j < 32;j++)
			{
				dec->Nik[i][j] = cos((16 + i) * (2 * j + 1) * 3.1415926 / 64.0);
			}
		}
	}
	return dec;
}

static int mp3dec_get_frame(unsigned char* buf,int size,char** ret)
{
	unsigned char* first = NULL;
	unsigned char* next = NULL;
	unsigned short sync = 0xfffd;
	while(size >= 2)
	{
		if((buf[0] == 0xff) && ((buf[1] & 0xf0) == 0xf0) )
		{
			sync = (buf[0] << 8) | buf[1];
			first = buf;
			size -= 2;
			buf += 2;
			break;
		}
		buf ++;
		size --;
	}
	while(size >= 2)
	{
		if(((buf[0] << 8) | buf[1]) == sync)
		{
			next = buf;
			break;
		}
		buf ++;
		size --;
	}
	if(!first || !next)
	{
		return 0;
	}
	*ret = first;
	size = (unsigned int)next - (unsigned int)first;
	return size;

}

int mp3dec_process(void* dec,char* buf,int size,short int* pcm,int* pcm_size)
{
	unsigned short sample_freq[]=
	{
		44100,48000,32000,0
	};
	int len;
	char* raw;
	mp3dec_t* mp3 = (mp3dec_t*)dec;
	bitstream_t* bs = &mp3->bs;

	mp3->pcm = pcm;
	mp3->pcm_size = 0;

	memcpy(mp3->buf + mp3->buf_size,buf,size);
	mp3->buf_size += size;


	buf = mp3->buf;
	size = mp3->buf_size;
	while((len = mp3dec_get_frame(buf,size,&raw)) != 0)
	{
		bs_reload(bs,raw,len);
		header(mp3);
		error_check(mp3);
		audio_data(mp3);
		ancillary_data(mp3);
		buf += len;
		size -= len;
	}
	if(size > 0)
	{
		memcpy(mp3->buf,buf,size);
		mp3->buf_size = size;
	}
	else
	{
		mp3->buf_size = 0;
	}


	if(pcm_size)
	{
		*pcm_size = mp3->pcm_size * sizeof(short int);
	}
	return (sample_freq[mp3->sampling_frequency] << 16) | (2 << 8) | 16;
}

void mp3dec_destroy(void* dec)
{
	osFree(dec);
}


